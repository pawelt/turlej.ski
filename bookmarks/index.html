<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Bookmarkd</title>
    <link rel="icon" href="data:," />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        *, *:before, *:after { box-sizing: border-box; }
        html, body { --content-width: 1260px; --group-width: 11rem; padding: 0; margin: 0; }
        body { padding-inline: 1rem; }
        ul { margin: 0; padding: 0; list-style: none; }
        h2 { font-family: Georgia; letter-spacing: 0.5px;margin: 0rem; margin-bottom: 0.25rem; padding-top: 0.25rem; padding-bottom: 0.15rem; line-height: 100%; font-size: 1.5rem; border-bottom: 1px solid; }
        a { display: inline-block; white-space: nowrap; overflow: hidden; max-width: 100%; text-overflow: ellipsis; }
        a { font-family: Segoe UI, Roboto, Helvetica Neue; font-size: 1.25rem; color: #0063d5; line-height: 2rem; text-decoration: none; }
        .controls {
            max-width: var(--content-width);
            margin: 0 auto;
        }
        .wrap {
            /* border: 1px dotted lime; */
            max-width: var(--content-width);
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(var(--group-width), 1fr));
            column-gap: 1rem;
        }
        .group {
            /* border: 1px dashed red; */
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div id="linksContainer" class="wrap">
        <h3>no links found</h3>
    </div>
    <div class="controls">
        <button id="btnToggle" onclick="toggleImportControls()">Manage</button>
        <br /><br />
        <button id="btnImport" onclick="importMarkdown()">Import markdown</button>
        <button id="btnExport" onclick="exportMarkdown()">Export markdown</button>
        <br /><br />
        <button id="btnClear" onclick="clearStoredMarkup()">Clear stored links</button>
        <br /><br />
        <textarea id="taMarkdown" rows="10" style="width: 100%"></textarea>
    </div>
    <script>
        const LS_KEY_HTML = "linksHtml";
        const LS_KEY_MD = "linksMd";

        toggleImportControls();
        if (localStorage[LS_KEY_HTML]) linksContainer.innerHTML = localStorage[LS_KEY_HTML];

        function toggleImportControls() {
            const nextDisplay = btnImport.style.display === "none" ? "" : "none";
            btnImport.style.display = nextDisplay;
            btnExport.style.display = nextDisplay;
            btnClear.style.display = nextDisplay;
            taMarkdown.style.display = nextDisplay;
            if (nextDisplay) taMarkdown.value = "";
        }

        function clearStoredMarkup() {
            if (!confirm("Clear stored markup?")) return;
            localStorage.removeItem(LS_KEY_HTML);
            localStorage.removeItem(LS_KEY_MD);
            linksContainer.innerHTML = "<h3>all bookmarks removed</h3>"
        }

        function importMarkdown() {
            const md = taMarkdown.value.trim();
            if (!md) return;
            const html = mdToHtml(md);
            if (!html || !confirm("Import generated markup?\n" + html)) return;
            localStorage.setItem(LS_KEY_HTML, html);
            localStorage.setItem(LS_KEY_MD, md);
            linksContainer.innerHTML = html;
        }

        function exportMarkdown() {
            if (!localStorage[LS_KEY_MD]) return alert("no stored links markdown found");
            taMarkdown.value = localStorage[LS_KEY_MD];
            taMarkdown.select();
        }

        function groupToMarkup(group) {
            if (!group || !group.links.length || !group.name) return "";
            return `
<div class="group">
    <h2>${group.name}</h2>
    <ul>
        ${group.links.join("\n        ")}
    </ul>
</div>`
        }

        function mdToHtml(md) {
            let curGroup = undefined; // { name: "", links: [] }
            let markup = "";
            const lines = md.split(/\n+/).map(l => l.trim()).filter(Boolean);
            for (const line of lines) {
                // skip level 3 and four sections completely
                if (line.startsWith("### ") || line.startsWith("#### ")) {
                    markup += groupToMarkup(curGroup);
                    curGroup = undefined;
                    continue;
                }
                // grab only level 2 sections
                if (line.startsWith("## ")) {
                    const name = line.substring(3).trim();
                    if (!name) continue;
                    markup += groupToMarkup(curGroup);
                    curGroup = { name, links: [] };
                    continue;
                }

                if (curGroup) {
                    const link = line.match(/\[([^\]]+)]\(([^)]+)/);
                    if (!link) continue;
                    curGroup.links.push(`<li><a href="${link[2]}">${link[1]}</a></li>`);
                }
            }
            markup += groupToMarkup(curGroup);
            return markup;
        }
    </script>
</body>
</html>
